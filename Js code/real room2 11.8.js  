// ============================================================
// main.js - æˆ¿é–“2ï¼šè‡ªåŠ›æ›´ç”Ÿç™¼å±•ç³»çµ±
// ============================================================
// ç‰ˆæœ¬: 2025/11/09 å°ˆæ³¨è‡ªèº«ç™¼å±•ç‰ˆ
// é©ç”¨å ´æ™¯: æˆ¿é–“2å–®ä¸€ Sourceï¼Œå°ˆæ³¨è‡ªèº«ç™¼å±•
// æ ¸å¿ƒç­–ç•¥: å¿«é€Ÿå‡ç´š RCLï¼Œå»ºç«‹å®Œæ•´ç¶“æ¿Ÿé«”ç³»
// 
// ä¸»è¦åŠŸèƒ½æ¨¡çµ„:
// 1. è¨˜æ†¶é«”æ¸…ç†ç³»çµ±
// 2. æ¨™æº–ä¸‰è§’è‰²ç”Ÿç”¢ç³»çµ± (Harvester, Upgrader, Builder)
// 3. è‡ªå‹•å»ºç¯‰å»ºé€ ç³»çµ± (Container, Extension, Tower, Storage)
// 4. é«˜æ•ˆèƒ½é‡ç®¡ç†ç³»çµ±
// ============================================================

// ============================================================
// é…ç½®å€ï¼šè«‹æ ¹æ“šä½ çš„å¯¦éš›æˆ¿é–“åç¨±ä¿®æ”¹
// ============================================================
const ROOM2_NAME = 'W2N28';  // æˆ¿é–“2çš„åç¨±ï¼ˆæœ¬æˆ¿é–“ï¼‰

module.exports.loop = function () {
    
    // ========================================================
    // æ¨¡çµ„ 1: è¨˜æ†¶é«”æ¸…ç†ç³»çµ±
    // ========================================================
    for(let name in Memory.creeps) {
        if(!Game.creeps[name]) {
            delete Memory.creeps[name];
            console.log('[Room2] æ¸…é™¤è¨˜æ†¶:', name);
        }
    }

    // ========================================================
    // æ¨¡çµ„ 2: è§’è‰²çµ±è¨ˆèˆ‡åŸºç¤è¨­å®š
    // ========================================================
    
    // çµ±è¨ˆå„è§’è‰²æ•¸é‡
    const harvesters = _.filter(Game.creeps, c => c.memory.role == 'harvester' && c.memory.homeRoom == ROOM2_NAME);
    const upgraders = _.filter(Game.creeps, c => c.memory.role == 'upgrader' && c.memory.homeRoom == ROOM2_NAME);
    const builders = _.filter(Game.creeps, c => c.memory.role == 'builder' && c.memory.homeRoom == ROOM2_NAME);
    
    // æ§åˆ¶å°è¼¸å‡º
    console.log('ğŸŒ [Room2] H:' + harvesters.length + ' | U:' + upgraders.length + ' | B:' + builders.length);

    // å–å¾— Spawnï¼ˆæ ¹æ“šæˆ¿é–“åç¨±è‡ªå‹•æ‰¾ï¼‰
    const spawn = Object.values(Game.spawns).find(s => s.room.name === ROOM2_NAME);
    
    if (!spawn) {
        console.log('[Room2] âŒ æ‰¾ä¸åˆ°æˆ¿é–“2çš„ Spawn');
        return;
    }
    
    const room = spawn.room;
    
    // å–å¾—ç•¶å‰ RCL
    const rcl = room.controller ? room.controller.level : 1;

    // ========================================================
    // æ¨¡çµ„ 3: Creep å‹•æ…‹ç”Ÿç”¢ç³»çµ±
    // ========================================================
    // æˆ¿é–“2äººå£é…ç½®ç­–ç•¥ï¼ˆè‡ªåŠ›æ›´ç”Ÿç‰ˆï¼‰ï¼š
    // 
    // ğŸ’¡ ç­–ç•¥èªªæ˜ï¼š
    // - å°ˆæ³¨æˆ¿é–“2è‡ªèº«ç™¼å±•
    // - å¿«é€Ÿè¡ RCLï¼Œè§£é–æ›´å¤šå»ºç¯‰å’ŒåŠŸèƒ½
    // - å»ºç«‹å®Œæ•´çš„ä¸‰è§’è‰²ç¶“æ¿Ÿé«”ç³»
    // 
    // é…ç½®ç­–ç•¥ï¼ˆä¾ RCL å‹•æ…‹èª¿æ•´ï¼‰ï¼š
    // RCL 1-2: H:2 U:2 B:1 (å¿«é€Ÿè¡ RCL3)
    // RCL 3-4: H:2 U:2 B:1 (ç©©å®šç™¼å±•)
    // RCL 5+:  H:3 U:3 B:2 (å…¨é¢ç™¼å±•)
    // 
    // å„ªé»ï¼š
    // - å°ˆæ³¨æå‡æˆ¿é–“2å¯¦åŠ›
    // - ç°¡å–®é«˜æ•ˆçš„ç¶“æ¿Ÿé«”ç³»
    // - æœªä¾†æœ‰é¤˜åŠ›å†è€ƒæ…®æ”¯æ´å…¶ä»–æˆ¿é–“
    // ========================================================
    
    // æ ¹æ“š RCL å‹•æ…‹èª¿æ•´äººå£é…ç½®
    let targetHarvesters, targetUpgraders, targetBuilders;
    
    if (rcl < 3) {
        // RCL 1-2: å¿«é€Ÿè¡ RCL3
        targetHarvesters = 2;
        targetUpgraders = 2;
        targetBuilders = 1;
    } else if (rcl < 5) {
        // RCL 3-4: ç©©å®šç™¼å±•
        targetHarvesters = 2;
        targetUpgraders = 2;
        targetBuilders = 1;
    } else {
        // RCL 5+: å…¨é¢ç™¼å±•
        targetHarvesters = 3;
        targetUpgraders = 3;
        targetBuilders = 2;
    }
    
    // ========================================================
    // ç”Ÿç”¢é‚è¼¯ 1: ç·Šæ€¥å•Ÿå‹•æ¨¡å¼
    // ========================================================
    if (!spawn.spawning && harvesters.length === 0) {
        if (room.energyAvailable >= 200) {
            const name = '[R2]Boot-' + Game.time;
            const body = [WORK, CARRY, MOVE];
            const res = spawn.spawnCreep(body, name, { 
                memory: { 
                    role: 'harvester',
                    homeRoom: ROOM2_NAME
                } 
            });
            if (res === OK) {
                console.log('[Room2] ğŸš¨ ç·Šæ€¥å•Ÿå‹•:', name);
            }
        }
    }
    
    // ========================================================
    // ç”Ÿç”¢é‚è¼¯ 2: ç”Ÿç”¢æœ¬åœ° Harvesterï¼ˆå„ªå…ˆï¼‰
    // ========================================================
    else if (!spawn.spawning && harvesters.length < targetHarvesters) {
        const ea = room.energyAvailable;
        let body;
        
        if (ea >= 550) {
            body = [WORK,WORK,WORK,CARRY,MOVE,MOVE];
        } else if (ea >= 400) {
            body = [WORK,WORK,CARRY,MOVE];
        } else if (ea >= 300) {
            body = [WORK,CARRY,MOVE,MOVE];
        } else if (ea >= 200) {
            body = [WORK,CARRY,MOVE];
        }
        
        if (body) {
            const name = '[R2]H-' + Game.time;
            const res = spawn.spawnCreep(body, name, { 
                memory: { 
                    role: 'harvester',
                    homeRoom: ROOM2_NAME
                } 
            });
            if (res === OK) {
                console.log('[Room2] â›ï¸ ç”Ÿç”¢ Harvester:', name);
            }
        }
    }
    
    // ========================================================
    // ç”Ÿç”¢é‚è¼¯ 3: ç”Ÿç”¢ Upgrader
    // ========================================================
    else if (!spawn.spawning && upgraders.length < targetUpgraders) {
        const ea = room.energyAvailable;
        let body;
        
        // Upgrader é…ç½®
        if (ea >= 550) {
            body = [WORK,WORK,WORK,CARRY,MOVE,MOVE];
        } else if (ea >= 400) {
            body = [WORK,WORK,CARRY,MOVE,MOVE];
        } else if (ea >= 300) {
            body = [WORK,CARRY,MOVE,MOVE];
        }
        
        if (body) {
            const name = '[R2]U-' + Game.time;
            const res = spawn.spawnCreep(body, name, {
                memory: {
                    role: 'upgrader',
                    homeRoom: ROOM2_NAME,
                    upgrading: false
                }
            });
            if (res === OK) {
                console.log('[Room2] âš¡ ç”Ÿç”¢ Upgrader:', name);
            }
        }
    }
    
    // ========================================================
    // ç”Ÿç”¢é‚è¼¯ 4: ç”Ÿç”¢ Builder
    // ========================================================
    else if (!spawn.spawning && builders.length < targetBuilders) {
        const ea = room.energyAvailable;
        let body;
        
        // Builder é…ç½®
        if (ea >= 550) {
            body = [WORK,WORK,WORK,CARRY,MOVE,MOVE];
        } else if (ea >= 400) {
            body = [WORK,WORK,CARRY,MOVE];
        } else if (ea >= 300) {
            body = [WORK,CARRY,MOVE,MOVE];
        }
        
        if (body) {
            const name = '[R2]B-' + Game.time;
            const res = spawn.spawnCreep(body, name, {
                memory: {
                    role: 'builder',
                    homeRoom: ROOM2_NAME,
                    building: false
                }
            });
            if (res === OK) {
                console.log('[Room2] ï¿½ ç”Ÿç”¢ Builder:', name);
            }
        }
    }

    // ========================================================
    // Spawn ç‹€æ…‹é¡¯ç¤º
    // ========================================================
    if(spawn.spawning) {
        const spawningCreep = Game.creeps[spawn.spawning.name];
        spawn.room.visual.text(
            'ğŸ› ï¸' + spawningCreep.memory.role,
            spawn.pos.x + 1,
            spawn.pos.y,
            {align: 'left', opacity: 0.8}
        );
    }

    // ========================================================
    // æ¨¡çµ„ 4: Creep ä»»å‹™åŸ·è¡Œç³»çµ±
    // ========================================================
    for(let name in Game.creeps) {
        const creep = Game.creeps[name];
        
        // åªåŸ·è¡Œæˆ¿é–“2çš„ creep
        if (creep.memory.homeRoom !== ROOM2_NAME) continue;
        
        if(creep.memory.role == 'harvester') {
            runHarvester(creep);
        }
        else if(creep.memory.role == 'upgrader') {
            runUpgrader(creep);
        }
        else if(creep.memory.role == 'builder') {
            runBuilder(creep);
        }
    }
}

// ============================================================
// Harvester è§’è‰²é‚è¼¯å‡½æ•¸
// ============================================================
// è§’è‰²å®šä½: æ¡é›†è€… + é‹è¼¸è€…
// ä¸»è¦ä»»å‹™: å¾ Source æ¡é›†èƒ½é‡ â†’ é‹é€åˆ° Spawn/Extension/Tower/Storage
// å·¥ä½œæµç¨‹:
//   1. èƒŒåŒ…ç©º â†’ å»æ¡é›†èƒ½é‡ (å„ªå…ˆå¾ Container å–,æ²’æœ‰æ‰ç›´æ¥æ¡ Source)
//   2. èƒŒåŒ…æ»¿ â†’ é‹é€èƒ½é‡ (å„ªå…ˆç´š: Spawn/Extension > Tower > Storage > Container)
//   3. ç„¡è™•å­˜æ”¾ â†’ å”åŠ©å»ºé€ æˆ–å‡ç´š (é¿å…é–’ç½®)
// ============================================================
function runHarvester(creep) {
    
    // === éšæ®µåˆ¤æ–·: èƒŒåŒ…æ˜¯å¦å·²æ»¿ ===
    if(creep.store.getFreeCapacity() == 0) {
        // èƒŒåŒ…å·²æ»¿,é€²å…¥é‹é€æ¨¡å¼
        
        // --- å„ªå…ˆç´š 1: è£œçµ¦ Spawn/Extension ---
        let target = creep.pos.findClosestByPath(FIND_STRUCTURES, {
            filter: s => (s.structureType === STRUCTURE_EXTENSION || 
                         s.structureType === STRUCTURE_SPAWN) &&
                         s.store.getFreeCapacity(RESOURCE_ENERGY) > 0
        });
        
        // --- å„ªå…ˆç´š 2: è£œçµ¦ Tower ---
        if (!target) {
            target = creep.pos.findClosestByPath(FIND_STRUCTURES, {
                filter: s => s.structureType === STRUCTURE_TOWER &&
                            s.store.getFreeCapacity(RESOURCE_ENERGY) > 200
            });
        }
        
        // --- å„ªå…ˆç´š 3: è£œçµ¦ Storage ---
        if (!target) {
            target = creep.pos.findClosestByPath(FIND_STRUCTURES, {
                filter: s => s.structureType === STRUCTURE_STORAGE &&
                            s.store.getFreeCapacity(RESOURCE_ENERGY) > 0
            });
        }
        
        // --- å„ªå…ˆç´š 4: è£œçµ¦ Container ---
        if (!target) {
            target = creep.pos.findClosestByPath(FIND_STRUCTURES, {
                filter: s => s.structureType === STRUCTURE_CONTAINER &&
                            s.store.getFreeCapacity(RESOURCE_ENERGY) > 0
            });
        }
        
        // å¦‚æœæ‰¾åˆ°ç›®æ¨™å»ºç¯‰
        if (target) {
            const transferResult = creep.transfer(target, RESOURCE_ENERGY);
            
            if (transferResult == ERR_NOT_IN_RANGE) {
                creep.moveTo(target, {
                    visualizePathStyle: {stroke: '#ffffff'}
                });
            }
            creep.say('ğŸšš');
        } else {
            // --- ç„¡è™•å­˜æ”¾: å”åŠ©å»ºé€ æˆ–å‡ç´š ---
            const site = creep.pos.findClosestByPath(FIND_CONSTRUCTION_SITES);
            
            if (site) {
                if (creep.build(site) == ERR_NOT_IN_RANGE) {
                    creep.moveTo(site, {
                        visualizePathStyle: {stroke: '#ffffff'}
                    });
                }
                creep.say('ğŸ”¨');
            } else {
                // æ²’å·¥åœ°å°±å”åŠ©å‡ç´š
                if (creep.upgradeController(creep.room.controller) == ERR_NOT_IN_RANGE) {
                    creep.moveTo(creep.room.controller, {
                        visualizePathStyle: {stroke: '#00ff00'}
                    });
                }
                creep.say('âš¡');
            }
        }
    }
    else {
        // èƒŒåŒ…æœªæ»¿,é€²å…¥æ¡é›†æ¨¡å¼
        
        // --- æ¡é›†ç­–ç•¥ 1: å„ªå…ˆå¾ Container æå–èƒ½é‡ ---
        const container = creep.pos.findClosestByPath(FIND_STRUCTURES, {
            filter: s => s.structureType == STRUCTURE_CONTAINER &&
                        s.store[RESOURCE_ENERGY] > 0
        });
        
        if (container) {
            const withdrawResult = creep.withdraw(container, RESOURCE_ENERGY);
            
            if (withdrawResult == ERR_NOT_IN_RANGE) {
                creep.moveTo(container, {
                    visualizePathStyle: {stroke: '#ffaa00'}
                });
            }
            creep.say('ğŸ’°');
        } else {
            // --- æ¡é›†ç­–ç•¥ 2: ç›´æ¥æ¡é›† Source ---
            let source = creep.pos.findClosestByPath(FIND_SOURCES_ACTIVE);
            
            if (!source) {
                source = creep.pos.findClosestByRange(FIND_SOURCES_ACTIVE);
            }
            
            if (source) {
                const harvestResult = creep.harvest(source);
                
                if (harvestResult == ERR_NOT_IN_RANGE) {
                    creep.moveTo(source, {
                        visualizePathStyle: {stroke: '#ffaa00'}
                    });
                }
                creep.say('â›ï¸');
            }
        }
    }
}

// ============================================================
// Upgrader è§’è‰²é‚è¼¯å‡½æ•¸
// ============================================================
// è§’è‰²å®šä½: æ§åˆ¶å™¨å‡ç´šå°ˆå“¡
// ä¸»è¦ä»»å‹™: æŒçºŒå‡ç´šæˆ¿é–“æ§åˆ¶å™¨ (Controller) æå‡ RCL
// å·¥ä½œæµç¨‹:
//   1. èƒŒåŒ…ç©º â†’ å»è£œå……èƒ½é‡ (å„ªå…ˆ Storage > Container > åœ°ä¸Šæ‰è½ > Source)
//   2. èƒŒåŒ…æ»¿ â†’ å»å‡ç´šæ§åˆ¶å™¨
//   3. ä½¿ç”¨è¨˜æ†¶é«”æ¨™è¨˜ç‹€æ…‹,é¿å…é »ç¹åˆ‡æ›
// ============================================================
function runUpgrader(creep) {
    
    // === ç‹€æ…‹åˆ‡æ›é‚è¼¯ ===
    if(creep.memory.upgrading && creep.store[RESOURCE_ENERGY] == 0) {
        creep.memory.upgrading = false;
        creep.say('ğŸ”„');
    }
    
    if(!creep.memory.upgrading && creep.store.getFreeCapacity() == 0) {
        creep.memory.upgrading = true;
        creep.say('âš¡');
    }
    
    // === åŸ·è¡Œå°æ‡‰çš„è¡Œå‹• ===
    if(creep.memory.upgrading) {
        // --- å‡ç´šæ¨¡å¼ ---
        const upgradeResult = creep.upgradeController(creep.room.controller);
        
        if (upgradeResult == ERR_NOT_IN_RANGE) {
            creep.moveTo(creep.room.controller, {
                visualizePathStyle: {stroke: '#00ff00'}
            });
        }
    }
    else {
        // --- æ¡é›†æ¨¡å¼ ---
        
        // å„ªå…ˆç´š 1: å¾ Storage æå–èƒ½é‡
        const storage = creep.pos.findClosestByPath(FIND_STRUCTURES, {
            filter: s => s.structureType == STRUCTURE_STORAGE &&
                        s.store[RESOURCE_ENERGY] > 0
        });
        
        if (storage) {
            const withdrawResult = creep.withdraw(storage, RESOURCE_ENERGY);
            
            if (withdrawResult == ERR_NOT_IN_RANGE) {
                creep.moveTo(storage, {
                    visualizePathStyle: {stroke: '#ffaa00'}
                });
            }
        } else {
            // å„ªå…ˆç´š 2: å¾ Container æå–èƒ½é‡
            const container = creep.pos.findClosestByPath(FIND_STRUCTURES, {
                filter: s => s.structureType == STRUCTURE_CONTAINER &&
                            s.store[RESOURCE_ENERGY] > 0
            });
            
            if(container) {
                const withdrawResult = creep.withdraw(container, RESOURCE_ENERGY);
                
                if (withdrawResult == ERR_NOT_IN_RANGE) {
                    creep.moveTo(container, {
                        visualizePathStyle: {stroke: '#ffaa00'}
                    });
                }
            } else {
                // å„ªå…ˆç´š 3: æ’¿åœ°ä¸Šæ‰è½çš„èƒ½é‡
                const droppedEnergy = creep.pos.findClosestByPath(FIND_DROPPED_RESOURCES, {
                    filter: r => r.resourceType === RESOURCE_ENERGY && r.amount > 50
                });
                
                if (droppedEnergy) {
                    if (creep.pickup(droppedEnergy) == ERR_NOT_IN_RANGE) {
                        creep.moveTo(droppedEnergy, {
                            visualizePathStyle: {stroke: '#ffaa00'}
                        });
                    }
                    creep.say('ğŸ’°');
                } else {
                    // å„ªå…ˆç´š 4: ç›´æ¥æ¡é›† Source
                    const source = creep.pos.findClosestByPath(FIND_SOURCES_ACTIVE);
                    
                    if (source) {
                        if (creep.harvest(source) == ERR_NOT_IN_RANGE) {
                            creep.moveTo(source, {
                                visualizePathStyle: {stroke: '#ffaa00'}
                            });
                        }
                        creep.say('â›ï¸');
                    }
                }
            }
        }
    }
}

// ============================================================
// Builder è§’è‰²é‚è¼¯å‡½æ•¸
// ============================================================
// è§’è‰²å®šä½: å»ºé€ è€… + ä¿®å¾©è€…
// ä¸»è¦ä»»å‹™: å»ºé€ å·¥åœ° â†’ ä¿®å¾©å»ºç¯‰ â†’ æ²’äº‹æ™‚å”åŠ©å‡ç´šæ§åˆ¶å™¨
// å·¥ä½œæµç¨‹:
//   1. èƒŒåŒ…ç©º â†’ å»è£œå……èƒ½é‡ (å„ªå…ˆ Storage > Container > åœ°ä¸Šæ‰è½ > Source)
//   2. èƒŒåŒ…æ»¿ â†’ å»å»ºé€ å·¥åœ° (æ²’å·¥åœ°å°±ä¿®å¾©å»ºç¯‰,å†æ²’äº‹å°±å‡ç´š)
//   3. ä½¿ç”¨è¨˜æ†¶é«”æ¨™è¨˜ç‹€æ…‹,é¿å…é »ç¹åˆ‡æ›
// ============================================================
function runBuilder(creep) {
    
    // === ç‹€æ…‹åˆ‡æ›é‚è¼¯ ===
    if(creep.memory.building && creep.store[RESOURCE_ENERGY] == 0) {
        creep.memory.building = false;
        creep.say('ğŸ”„');
    }
    
    if(!creep.memory.building && creep.store.getFreeCapacity() == 0) {
        creep.memory.building = true;
        creep.say('ï¿½');
    }
    
    // === åŸ·è¡Œå°æ‡‰çš„è¡Œå‹• ===
    if(creep.memory.building) {
        // --- å»ºé€ æ¨¡å¼ ---
        
        // å„ªå…ˆç´š 1: å»ºé€ å·¥åœ°
        const target = creep.pos.findClosestByPath(FIND_CONSTRUCTION_SITES);
        
        if(target) {
            const buildResult = creep.build(target);
            
            if (buildResult == ERR_NOT_IN_RANGE) {
                creep.moveTo(target, {
                    visualizePathStyle: {stroke: '#ffffff'}
                });
            }
        }
        else {
            // å„ªå…ˆç´š 2: ä¿®å¾©å—æå»ºç¯‰ (è¡€é‡ < 80%)
            const damagedStructure = creep.pos.findClosestByPath(FIND_STRUCTURES, {
                filter: s => s.hits < s.hitsMax * 0.8 &&
                            s.structureType != STRUCTURE_WALL &&
                            s.structureType != STRUCTURE_RAMPART
            });
            
            if (damagedStructure) {
                if (creep.repair(damagedStructure) == ERR_NOT_IN_RANGE) {
                    creep.moveTo(damagedStructure, {
                        visualizePathStyle: {stroke: '#ffffff'}
                    });
                }
                creep.say('ğŸ”§');
            } else {
                // å„ªå…ˆç´š 3: å”åŠ©å‡ç´šæ§åˆ¶å™¨
                const upgradeResult = creep.upgradeController(creep.room.controller);
                
                if (upgradeResult == ERR_NOT_IN_RANGE) {
                    creep.moveTo(creep.room.controller, {
                        visualizePathStyle: {stroke: '#00ff00'}
                    });
                }
                creep.say('âš¡');
            }
        }
    }
    else {
        // --- æ¡é›†æ¨¡å¼ ---
        
        // å„ªå…ˆç´š 1: å¾ Storage æå–èƒ½é‡
        const storage = creep.pos.findClosestByPath(FIND_STRUCTURES, {
            filter: s => s.structureType == STRUCTURE_STORAGE &&
                        s.store[RESOURCE_ENERGY] > 0
        });
        
        if (storage) {
            const withdrawResult = creep.withdraw(storage, RESOURCE_ENERGY);
            
            if (withdrawResult == ERR_NOT_IN_RANGE) {
                creep.moveTo(storage, {
                    visualizePathStyle: {stroke: '#ffaa00'}
                });
            }
        } else {
            // å„ªå…ˆç´š 2: å¾ Container æå–èƒ½é‡
            const container = creep.pos.findClosestByPath(FIND_STRUCTURES, {
                filter: s => s.structureType == STRUCTURE_CONTAINER &&
                            s.store[RESOURCE_ENERGY] > 0
            });
            
            if(container) {
                const withdrawResult = creep.withdraw(container, RESOURCE_ENERGY);
                
                if (withdrawResult == ERR_NOT_IN_RANGE) {
                    creep.moveTo(container, {
                        visualizePathStyle: {stroke: '#ffaa00'}
                    });
                }
            } else {
                // å„ªå…ˆç´š 3: æ’¿åœ°ä¸Šæ‰è½çš„èƒ½é‡
                const droppedEnergy = creep.pos.findClosestByPath(FIND_DROPPED_RESOURCES, {
                    filter: r => r.resourceType === RESOURCE_ENERGY && r.amount > 50
                });
                
                if (droppedEnergy) {
                    if (creep.pickup(droppedEnergy) == ERR_NOT_IN_RANGE) {
                        creep.moveTo(droppedEnergy, {
                            visualizePathStyle: {stroke: '#ffaa00'}
                        });
                    }
                    creep.say('ğŸ’°');
                } else {
                    // å„ªå…ˆç´š 4: ç›´æ¥æ¡é›† Source
                    const source = creep.pos.findClosestByPath(FIND_SOURCES_ACTIVE);
                    
                    if (source) {
                        if (creep.harvest(source) == ERR_NOT_IN_RANGE) {
                            creep.moveTo(source, {
                                visualizePathStyle: {stroke: '#ffaa00'}
                            });
                        }
                        creep.say('â›ï¸');
                    }
                }
            }
        }
    }
}

// ============================================================
// ç¨‹å¼ç¢¼çµæŸ
// ============================================================
// æˆ¿é–“2é…ç½®ç¸½çµï¼ˆè‡ªåŠ›æ›´ç”Ÿç‰ˆ v1.0ï¼‰:
// âœ… æ¨™æº–ä¸‰è§’è‰²ç³»çµ± (Harvester, Upgrader, Builder)
// âœ… æ ¹æ“š RCL å‹•æ…‹èª¿æ•´äººå£é…ç½®
// âœ… å°ˆæ³¨æˆ¿é–“2è‡ªèº«ç™¼å±•
// âœ… å®Œæ•´çš„èƒ½é‡ç®¡ç†ç³»çµ± (Storage, Container å„ªå…ˆ)
// âœ… ç°¡å–®é«˜æ•ˆçš„ç¶“æ¿Ÿé«”ç³»
// 
// ç³»çµ±å·¥ä½œæµç¨‹:
// 1. Harvester æ¡é›†èƒ½é‡ä¸¦é‹è¼¸åˆ°å»ºç¯‰
// 2. Upgrader æŒçºŒå‡ç´š Controller
// 3. Builder å»ºé€ å·¥åœ°å’Œä¿®å¾©å»ºç¯‰
// 4. æ‰€æœ‰è§’è‰²å„ªå…ˆå¾ Storage/Container å–èƒ½é‡
// 5. èƒ½é‡ç®¡ç†: Storage > Container > åœ°ä¸Šæ‰è½ > Source
// 
// å„ªé»åˆ†æ:
// - â­ å°ˆæ³¨æå‡æˆ¿é–“2å¯¦åŠ›
// - â­ ç°¡å–®æ˜“ç¶­è­·çš„ä¸‰è§’è‰²ç³»çµ±
// - â­ æ ¹æ“š RCL è‡ªå‹•èª¿æ•´é…ç½®
// - â­ å®Œæ•´çš„èƒ½é‡å„ªå…ˆç´šç³»çµ±
// - â­ æœªä¾†æœ‰é¤˜åŠ›å†è€ƒæ…®æ”¯æ´å…¶ä»–æˆ¿é–“
// 
// ä½¿ç”¨èªªæ˜:
// 1. ã€å»ºè­°ã€‘æ¸…é™¤èˆŠçš„ Transporter creep:
//    Game.creeps['[R2â†’R1]T-xxxxx'].suicide();
// 
// 2. ç­‰å¾…æ–° creep ç”Ÿç”¢ï¼ˆå„ªå…ˆé †åºï¼‰ï¼š
//    - ç¬¬1å€‹ï¼šHarvesterï¼ˆæ¡é›†èƒ½é‡ï¼‰
//    - ç¬¬2å€‹ï¼šUpgraderï¼ˆå‡ç´š Controllerï¼‰
//    - ç¬¬3å€‹ï¼šHarvesterï¼ˆå¢å¼·æ¡é›†ï¼‰
//    - ç¬¬4å€‹ï¼šUpgraderï¼ˆåŠ å¼·å‡ç´šï¼‰
//    - ç¬¬5å€‹ï¼šBuilderï¼ˆå»ºé€ å»ºç¯‰ï¼‰
// 
// 3. è§€å¯Ÿ Console è¼¸å‡ºï¼š
//    ğŸŒ [Room2] H:2 | U:2 | B:1
// 
// 4. ç™¼å±•ç›®æ¨™ï¼š
//    - çŸ­æœŸ: å¿«é€Ÿè¡åˆ° RCL3 (è§£é– Tower)
//    - ä¸­æœŸ: å»ºç«‹å®Œæ•´ç¶“æ¿Ÿé«”ç³» (Container, Extension, Storage)
//    - é•·æœŸ: é”åˆ° RCL5+ å¾Œæœ‰é¤˜åŠ›æ”¯æ´å…¶ä»–æˆ¿é–“
// 
// è¦–è¦ºåŒ–æŒ‡ç¤º:
// - â›ï¸: æ¡é›†ä¸­
// - ğŸ’°: æ’¿èƒ½é‡ä¸­
// - ğŸšš: é‹è¼¸èƒ½é‡ä¸­
// - âš¡: å‡ç´šä¸­
// - ğŸ”¨: å»ºé€ ä¸­
// - ï¿½: ä¿®å¾©ä¸­
// - ğŸ”„: åˆ‡æ›ç‹€æ…‹
// 
// è·¯å¾‘é¡è‰²:
// - æ©˜è‰² (#ffaa00): æ¡é›†/æ’¿èƒ½é‡
// - ç¶ è‰² (#00ff00): å‡ç´šä¸­
// - ç™½è‰² (#ffffff): å»ºé€ /é‹è¼¸/ä¿®å¾©ä¸­
// ============================================================