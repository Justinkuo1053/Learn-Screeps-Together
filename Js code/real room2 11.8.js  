// ============================================================
// main.js - æˆ¿é–“2ï¼šè·¨æˆ¿é–“æ”¯æ´ç³»çµ±
// ============================================================
// ç‰ˆæœ¬: 2025/11/09 æ”¯æ´æˆ¿é–“1å°ˆç”¨ç‰ˆ
// é©ç”¨å ´æ™¯: æˆ¿é–“2å–®ä¸€ Sourceï¼Œå°ˆé–€æ”¯æ´æˆ¿é–“1çš„ Controller å‡ç´š
// æ ¸å¿ƒç­–ç•¥: æœ€å°åŒ–æˆ¿é–“2å»ºè¨­ï¼Œæœ€å¤§åŒ–å°æˆ¿é–“1çš„æ”¯æ´
// 
// ä¸»è¦åŠŸèƒ½æ¨¡çµ„:
// 1. è¨˜æ†¶é«”æ¸…ç†ç³»çµ±
// 2. è·¨æˆ¿é–“ Upgrader ç”Ÿç”¢ç³»çµ±ï¼ˆä¸»åŠ›è§’è‰²ï¼‰
// 3. å°‘é‡æœ¬åœ° Harvesterï¼ˆç¶­æŒåŸºæœ¬é‹ä½œï¼‰
// 4. ç°¡åŒ–å»ºç¯‰ç³»çµ±ï¼ˆä¸å»º Container/Tower/Storageï¼‰
// ============================================================

// ============================================================
// é…ç½®å€ï¼šè«‹æ ¹æ“šä½ çš„å¯¦éš›æˆ¿é–“åç¨±ä¿®æ”¹
// ============================================================
const ROOM1_NAME = 'W3N28';  // æˆ¿é–“1çš„åç¨±ï¼ˆä¸»æˆ¿é–“ï¼Œè¦æ”¯æ´çš„ç›®æ¨™ï¼‰
const ROOM2_NAME = 'W3N27';  // æˆ¿é–“2çš„åç¨±ï¼ˆæœ¬æˆ¿é–“ï¼Œæ”¯æ´æˆ¿é–“ï¼‰

module.exports.loop = function () {
    
    // ========================================================
    // æ¨¡çµ„ 1: è¨˜æ†¶é«”æ¸…ç†ç³»çµ±
    // ========================================================
    for(let name in Memory.creeps) {
        if(!Game.creeps[name]) {
            delete Memory.creeps[name];
            console.log('[Room2] æ¸…é™¤è¨˜æ†¶:', name);
        }
    }

    // ========================================================
    // æ¨¡çµ„ 2: è§’è‰²çµ±è¨ˆèˆ‡åŸºç¤è¨­å®š
    // ========================================================
    
    // çµ±è¨ˆå„è§’è‰²æ•¸é‡
    const harvesters = _.filter(Game.creeps, c => c.memory.role == 'harvester' && c.memory.homeRoom == ROOM2_NAME);
    const localUpgraders = _.filter(Game.creeps, c => c.memory.role == 'localUpgrader' && c.memory.homeRoom == ROOM2_NAME);
    const crossRoomUpgraders = _.filter(Game.creeps, c => c.memory.role == 'crossRoomUpgrader' && c.memory.homeRoom == ROOM2_NAME);
    
    // æ§åˆ¶å°è¼¸å‡º
    console.log('ğŸŒ [Room2] H:' + harvesters.length + ' | LocalU:' + localUpgraders.length + ' | CrossU:' + crossRoomUpgraders.length);

    // å–å¾— Spawnï¼ˆæ ¹æ“šæˆ¿é–“åç¨±è‡ªå‹•æ‰¾ï¼‰
    const spawn = Object.values(Game.spawns).find(s => s.room.name === ROOM2_NAME);
    
    if (!spawn) {
        console.log('[Room2] âŒ æ‰¾ä¸åˆ°æˆ¿é–“2çš„ Spawn');
        return;
    }
    
    const room = spawn.room;

    // ========================================================
    // æ¨¡çµ„ 3: Creep å‹•æ…‹ç”Ÿç”¢ç³»çµ±
    // ========================================================
    // æˆ¿é–“2äººå£é…ç½®ç­–ç•¥ï¼ˆé›™é‡ç›®æ¨™å„ªåŒ–ç‰ˆï¼‰ï¼š
    // 
    // ã€é‡è¦çŸ¥è­˜ã€‘Controller å‡ç´šé™åˆ¶ï¼š
    // - æ¯å€‹ Controller æ¯ tick æœ€å¤šæ¥å— 15 èƒ½é‡
    // - 1å€‹ WORK éƒ¨ä»¶ = 1 èƒ½é‡/tick
    // - æ‰€ä»¥ç†è«–ä¸Š 15 å€‹ WORK éƒ¨ä»¶å°±é£½å’Œäº†
    // - å¯¦éš›å»ºè­°ï¼š2-3 å€‹ Upgraderï¼ˆæ¯å€‹ 3-4 WORKï¼‰= 9-12 èƒ½é‡/tick
    // 
    // é…ç½®ç­–ç•¥ï¼š
    // - 2 å€‹æœ¬åœ° Harvesterï¼š1å€‹æ¡é›†ï¼Œ1å€‹åŒæ™‚ç¶­è­·æˆ¿é–“2 Controller
    // - 2 å€‹è·¨æˆ¿é–“ Upgraderï¼šå°ˆè·æ”¯æ´æˆ¿é–“1ï¼ˆé¿å… Controller æ“æ“ ï¼‰
    // - 1 å€‹æœ¬åœ° Upgraderï¼šç·Šæ€¥æ•‘æ´æˆ¿é–“2 Controllerï¼ˆé˜²æ­¢ Downgradeï¼‰
    // 
    // å„ªé»ï¼š
    // - æ•‘æ´æˆ¿é–“2 Controllerï¼ˆé¿å… Downgradeï¼‰
    // - ä¸éåº¦æ“æ“ æˆ¿é–“1 Controllerï¼ˆå°Šé‡ 15 èƒ½é‡/tick é™åˆ¶ï¼‰
    // - å¹³è¡¡å…©å€‹æˆ¿é–“çš„ç™¼å±•éœ€æ±‚
    // ========================================================
    
    const targetHarvesters = 2;              // æœ¬åœ°æ¡é›†è€…
    const targetLocalUpgraders = 1;          // æœ¬åœ°å‡ç´šè€…ï¼ˆæ•‘æ´æˆ¿é–“2 Controllerï¼‰
    const targetCrossRoomUpgraders = 2;      // è·¨æˆ¿é–“æ”¯æ´è€…ï¼ˆé¿å…æ“æ“ ï¼‰
    
    // ========================================================
    // ç”Ÿç”¢é‚è¼¯ 1: ç·Šæ€¥å•Ÿå‹•æ¨¡å¼
    // ========================================================
    if (!spawn.spawning && harvesters.length === 0) {
        if (room.energyAvailable >= 200) {
            const name = '[R2]Boot-' + Game.time;
            const body = [WORK, CARRY, MOVE];
            const res = spawn.spawnCreep(body, name, { 
                memory: { 
                    role: 'harvester',
                    homeRoom: ROOM2_NAME
                } 
            });
            if (res === OK) {
                console.log('[Room2] ğŸš¨ ç·Šæ€¥å•Ÿå‹•:', name);
            }
        }
    }
    
    // ========================================================
    // ç”Ÿç”¢é‚è¼¯ 2: ç”Ÿç”¢æœ¬åœ° Harvesterï¼ˆå„ªå…ˆï¼‰
    // ========================================================
    else if (!spawn.spawning && harvesters.length < targetHarvesters) {
        const ea = room.energyAvailable;
        let body;
        
        if (ea >= 550) {
            body = [WORK,WORK,WORK,CARRY,MOVE,MOVE];
        } else if (ea >= 400) {
            body = [WORK,WORK,CARRY,MOVE];
        } else if (ea >= 300) {
            body = [WORK,CARRY,MOVE,MOVE];
        } else if (ea >= 200) {
            body = [WORK,CARRY,MOVE];
        }
        
        if (body) {
            const name = '[R2]H-' + Game.time;
            const res = spawn.spawnCreep(body, name, { 
                memory: { 
                    role: 'harvester',
                    homeRoom: ROOM2_NAME
                } 
            });
            if (res === OK) {
                console.log('[Room2] â›ï¸ ç”Ÿç”¢ Harvester:', name);
            }
        }
    }
    
    // ========================================================
    // ç”Ÿç”¢é‚è¼¯ 3: ç”Ÿç”¢æœ¬åœ° Upgraderï¼ˆç·Šæ€¥æ•‘æ´æˆ¿é–“2ï¼‰
    // ========================================================
    else if (!spawn.spawning && localUpgraders.length < targetLocalUpgraders) {
        const ea = room.energyAvailable;
        let body;
        
        // æœ¬åœ° Upgrader é…ç½®ï¼ˆä¸éœ€è¦å¤ªå¤š MOVEï¼‰
        if (ea >= 550) {
            // 3 WORK + 1 CARRY + 2 MOVE
            body = [WORK,WORK,WORK,CARRY,MOVE,MOVE];
        } else if (ea >= 400) {
            // 2 WORK + 1 CARRY + 2 MOVE
            body = [WORK,WORK,CARRY,MOVE,MOVE];
        } else if (ea >= 300) {
            // 1 WORK + 1 CARRY + 2 MOVE
            body = [WORK,CARRY,MOVE,MOVE];
        }
        
        if (body) {
            const name = '[R2]LocalU-' + Game.time;
            const res = spawn.spawnCreep(body, name, {
                memory: {
                    role: 'localUpgrader',
                    homeRoom: ROOM2_NAME,
                    working: false
                }
            });
            if (res === OK) {
                console.log('[Room2] ğŸ†˜ ç”Ÿç”¢æœ¬åœ° Upgrader (æ•‘æ´ Controller):', name);
            }
        }
    }
    
    // ========================================================
    // ç”Ÿç”¢é‚è¼¯ 4: ç”Ÿç”¢è·¨æˆ¿é–“ Upgraderï¼ˆæ”¯æ´æˆ¿é–“1ï¼‰
    // ========================================================
    else if (!spawn.spawning && crossRoomUpgraders.length < targetCrossRoomUpgraders) {
        const ea = room.energyAvailable;
        let body;
        
        // è·¨æˆ¿é–“ Upgrader éœ€è¦æ›´å¤š MOVEï¼ˆé•·è·é›¢ç§»å‹•ï¼‰
        if (ea >= 800) {
            // 4 WORK + 2 CARRY + 4 MOVE (ç§»å‹•ä¸æ¸›é€Ÿ)
            body = [WORK,WORK,WORK,WORK,CARRY,CARRY,MOVE,MOVE,MOVE,MOVE];
        } else if (ea >= 600) {
            // 3 WORK + 2 CARRY + 3 MOVE
            body = [WORK,WORK,WORK,CARRY,CARRY,MOVE,MOVE,MOVE];
        } else if (ea >= 400) {
            // 2 WORK + 1 CARRY + 2 MOVE
            body = [WORK,WORK,CARRY,MOVE,MOVE];
        } else if (ea >= 300) {
            // 1 WORK + 1 CARRY + 2 MOVE
            body = [WORK,CARRY,MOVE,MOVE];
        }
        
        if (body) {
            const name = '[R2â†’R1]U-' + Game.time;
            const res = spawn.spawnCreep(body, name, {
                memory: {
                    role: 'crossRoomUpgrader',
                    homeRoom: ROOM2_NAME,
                    targetRoom: ROOM1_NAME,
                    working: false
                }
            });
            if (res === OK) {
                console.log('[Room2] ğŸŒ ç”Ÿç”¢è·¨æˆ¿é–“ Upgrader:', name);
            }
        }
    }

    // ========================================================
    // Spawn ç‹€æ…‹é¡¯ç¤º
    // ========================================================
    if(spawn.spawning) {
        const spawningCreep = Game.creeps[spawn.spawning.name];
        spawn.room.visual.text(
            'ğŸ› ï¸' + spawningCreep.memory.role,
            spawn.pos.x + 1,
            spawn.pos.y,
            {align: 'left', opacity: 0.8}
        );
    }

    // ========================================================
    // æ¨¡çµ„ 4: Creep ä»»å‹™åŸ·è¡Œç³»çµ±
    // ========================================================
    for(let name in Game.creeps) {
        const creep = Game.creeps[name];
        
        // åªåŸ·è¡Œæˆ¿é–“2çš„ creep
        if (creep.memory.homeRoom !== ROOM2_NAME) continue;
        
        if(creep.memory.role == 'harvester') {
            runHarvester(creep);
        }
        else if(creep.memory.role == 'localUpgrader') {
            runLocalUpgrader(creep);
        }
        else if(creep.memory.role == 'crossRoomUpgrader') {
            runCrossRoomUpgrader(creep);
        }
    }
}

// ============================================================
// Harvester è§’è‰²é‚è¼¯å‡½æ•¸ï¼ˆå›ºå®šç«™ä½æ¡é›†ç‰ˆï¼‰
// ============================================================
// è§’è‰²å®šä½: å›ºå®šç«™ä½æ¡é›†å°ˆå“¡
// ä¸»è¦ä»»å‹™: 
//   1. æ‰¾åˆ° Source æ—æœ€ä½³ä½ç½®ï¼ˆåªéœ€ä¸€æ¬¡ï¼‰
//   2. ç«™åœ¨å›ºå®šä½ç½®æŒçºŒæ¡é›†
//   3. èƒ½é‡æ‰åœ¨åœ°ä¸Šè®“å…¶ä»– creep æ’¿
// å„ªé»: ä¸ç§»å‹• = 100% å·¥ä½œæ•ˆç‡ï¼Œä¸é˜»æ“‹å…¶ä»– creep
// ============================================================
function runHarvester(creep) {
    
    // === ç¬¬ä¸€æ¬¡åŸ·è¡Œï¼šè¨˜éŒ„å›ºå®šç«™ä½ ===
    if (!creep.memory.fixedPos) {
        const source = creep.pos.findClosestByPath(FIND_SOURCES);
        
        if (source) {
            // æ‰¾ Source æ—çš„ç©ºä½
            const pos = source.pos;
            const terrain = creep.room.getTerrain();
            
            for (let dx = -1; dx <= 1; dx++) {
                for (let dy = -1; dy <= 1; dy++) {
                    if (dx === 0 && dy === 0) continue;
                    
                    const x = pos.x + dx;
                    const y = pos.y + dy;
                    
                    if (terrain.get(x, y) !== TERRAIN_MASK_WALL) {
                        // æ‰¾åˆ°å¯ç”¨ä½ç½®ï¼Œè¨˜éŒ„ä¸‹ä¾†
                        creep.memory.fixedPos = { x, y };
                        creep.memory.sourceId = source.id;
                        console.log(`[R2] ${creep.name} é¸æ“‡å›ºå®šä½ç½® (${x},${y})`);
                        break;
                    }
                }
                if (creep.memory.fixedPos) break;
            }
        }
    }
    
    // === ç§»å‹•åˆ°å›ºå®šä½ç½® ===
    if (creep.memory.fixedPos) {
        const targetPos = new RoomPosition(
            creep.memory.fixedPos.x,
            creep.memory.fixedPos.y,
            creep.room.name
        );
        
        if (!creep.pos.isEqualTo(targetPos)) {
            // é‚„æ²’åˆ°å›ºå®šä½ç½®ï¼Œç§»å‹•éå»
            creep.moveTo(targetPos, {
                visualizePathStyle: { stroke: '#ffaa00' }
            });
            creep.say('ğŸ“');
            return;
        }
        
        // === å·²åœ¨å›ºå®šä½ç½®ï¼Œé–‹å§‹æ¡é›† ===
        const source = Game.getObjectById(creep.memory.sourceId);
        
        if (source) {
            const result = creep.harvest(source);
            
            if (result === OK) {
                creep.say('â›ï¸');
            }
            
            // èƒŒåŒ…æ»¿äº†ï¼ŒæŠŠèƒ½é‡ä¸Ÿåˆ°åœ°ä¸Š
            if (creep.store.getFreeCapacity() === 0) {
                // å…ˆè£œçµ¦ Spawn/Extension
                const structures = creep.pos.findInRange(FIND_STRUCTURES, 1, {
                    filter: s => (s.structureType === STRUCTURE_SPAWN || 
                                 s.structureType === STRUCTURE_EXTENSION) &&
                                 s.store.getFreeCapacity(RESOURCE_ENERGY) > 0
                });
                
                if (structures.length > 0) {
                    creep.transfer(structures[0], RESOURCE_ENERGY);
                } else {
                    // æ²’æœ‰å»ºç¯‰åœ¨æ—é‚Šï¼Œèƒ½é‡æœƒè‡ªå‹•æ‰åœ°ä¸Š
                    // å…¶ä»– creep æœƒä¾†æ’¿
                }
            }
        }
    }
}

// ============================================================
// æœ¬åœ° Upgrader è§’è‰²é‚è¼¯å‡½æ•¸
// ============================================================
// è§’è‰²å®šä½: æˆ¿é–“2 Controller ç¶­è­·å°ˆå“¡
// ä¸»è¦ä»»å‹™: å°ˆè·å‡ç´šæˆ¿é–“2çš„ Controllerï¼Œé˜²æ­¢ Downgrade
// å·¥ä½œæµç¨‹:
//   1. èƒŒåŒ…ç©º â†’ å¾ Source æ¡é›†èƒ½é‡
//   2. èƒŒåŒ…æ»¿ â†’ å‡ç´šæˆ¿é–“2çš„ Controller
//   3. æ°¸ä¸é›¢é–‹æˆ¿é–“2
// å„ªå…ˆç´š: æ•‘æ´ä»»å‹™ï¼Œæœ€é«˜å„ªå…ˆç”Ÿç”¢
// ============================================================
function runLocalUpgrader(creep) {
    
    // === ç‹€æ…‹åˆ‡æ›é‚è¼¯ ===
    if(creep.memory.working && creep.store[RESOURCE_ENERGY] == 0) {
        creep.memory.working = false;
        creep.say('ğŸ”„ æ¡é›†');
    }
    
    if(!creep.memory.working && creep.store.getFreeCapacity() == 0) {
        creep.memory.working = true;
        creep.say('âš¡ å‡ç´š');
    }
    
    // === åŸ·è¡Œå°æ‡‰çš„è¡Œå‹• ===
    if(creep.memory.working) {
        // --- å‡ç´šæˆ¿é–“2çš„ Controller ---
        const controller = creep.room.controller;
        
        if (controller) {
            const upgradeResult = creep.upgradeController(controller);
            
            if (upgradeResult == ERR_NOT_IN_RANGE) {
                creep.moveTo(controller, {
                    visualizePathStyle: {stroke: '#00ff00'}  // ç¶ è‰²ï¼ˆå‡ç´šä¸­ï¼‰
                });
            }
        }
    }
    else {
        // --- æ¡é›†èƒ½é‡ ---
        const source = creep.pos.findClosestByPath(FIND_SOURCES_ACTIVE);
        
        if (source) {
            const harvestResult = creep.harvest(source);
            
            if (harvestResult == ERR_NOT_IN_RANGE) {
                creep.moveTo(source, {
                    visualizePathStyle: {stroke: '#ffff00'}  // é»ƒè‰²ï¼ˆæ¡é›†ä¸­ï¼‰
                });
            }
        }
    }
}

// ============================================================
// è·¨æˆ¿é–“ Upgrader è§’è‰²é‚è¼¯å‡½æ•¸
// ============================================================
// è§’è‰²å®šä½: è·¨æˆ¿é–“æ”¯æ´å‡ç´šå°ˆå“¡
// ä¸»è¦ä»»å‹™: åœ¨æˆ¿é–“2æ¡é›†èƒ½é‡ â†’ ç§»å‹•åˆ°æˆ¿é–“1 â†’ å‡ç´šæˆ¿é–“1çš„ Controller
// å·¥ä½œæµç¨‹:
//   1. åœ¨æˆ¿é–“2ç›´æ¥å¾ Source æ¡é›†èƒ½é‡ï¼ˆä¸ç”¨ Containerï¼‰
//   2. èƒ½é‡æ»¿å¾Œç§»å‹•åˆ°æˆ¿é–“1
//   3. åœ¨æˆ¿é–“1å‡ç´š Controller
//   4. èƒ½é‡ç”¨å®Œå¾Œè¿”å›æˆ¿é–“2é‡æ–°æ¡é›†
// ============================================================
function runCrossRoomUpgrader(creep) {
    
    // === ç‹€æ…‹åˆ‡æ›é‚è¼¯ ===
    if(creep.memory.working && creep.store[RESOURCE_ENERGY] == 0) {
        creep.memory.working = false;
        creep.say('ğŸ”„ è¿”å›');
    }
    
    if(!creep.memory.working && creep.store.getFreeCapacity() == 0) {
        creep.memory.working = true;
        creep.say('ğŸš€ å‡ºç™¼');
    }
    
    // === åŸ·è¡Œå°æ‡‰çš„è¡Œå‹• ===
    if(creep.memory.working) {
        // --- å·¥ä½œæ¨¡å¼: å‰å¾€æˆ¿é–“1å‡ç´š ---
        
        if (creep.room.name !== creep.memory.targetRoom) {
            // é‚„æ²’åˆ°ç›®æ¨™æˆ¿é–“ï¼Œç§»å‹•éå»
            const exitDir = creep.room.findExitTo(creep.memory.targetRoom);
            
            if (exitDir === ERR_NO_PATH || exitDir === ERR_INVALID_ARGS) {
                console.log(`[R2â†’R1] âŒ ${creep.name} æ‰¾ä¸åˆ°å‰å¾€ ${creep.memory.targetRoom} çš„è·¯å¾‘`);
                return;
            }
            
            const exit = creep.pos.findClosestByPath(exitDir);
            if (exit) {
                creep.moveTo(exit, {
                    visualizePathStyle: {stroke: '#00ffff'}  // é’è‰²ï¼ˆè·¨æˆ¿é–“ï¼‰
                });
            }
        }
        else {
            // === å·²åœ¨ç›®æ¨™æˆ¿é–“ï¼Œå‡ç´š Controllerï¼ˆé˜²æ“æ“ æ©Ÿåˆ¶ï¼‰===
            const controller = creep.room.controller;
            
            if (!controller) {
                console.log(`[R2â†’R1] âŒ ${creep.name} åœ¨ ${creep.room.name} æ‰¾ä¸åˆ° Controller`);
                return;
            }
            
            // æª¢æŸ¥ Controller å‘¨åœæ˜¯å¦å·²ç¶“æœ‰å¤ªå¤š creep
            const nearbyCreeps = controller.pos.findInRange(FIND_MY_CREEPS, 3, {
                filter: c => c.memory.role === 'crossRoomUpgrader' || c.memory.role === 'upgrader'
            });
            
            // å¦‚æœå‘¨åœå·²ç¶“æœ‰ 3 å€‹ä»¥ä¸Š Upgraderï¼Œå°±ç­‰å¾…æˆ–å»ºé€ 
            if (nearbyCreeps.length > 3 && !nearbyCreeps.some(c => c.id === creep.id)) {
                // å°‹æ‰¾å·¥åœ°å”åŠ©å»ºé€ 
                const constructionSite = creep.pos.findClosestByPath(FIND_CONSTRUCTION_SITES);
                
                if (constructionSite) {
                    if (creep.build(constructionSite) == ERR_NOT_IN_RANGE) {
                        creep.moveTo(constructionSite, {
                            visualizePathStyle: {stroke: '#ffffff'}  // ç™½è‰²ï¼ˆå»ºé€ ä¸­ï¼‰
                        });
                    }
                    creep.say('ğŸ—ï¸');
                } else {
                    // æ²’äº‹åšå°±ç­‰å¾…åœ¨é™„è¿‘
                    creep.say('â¸ï¸');
                }
            }
            else {
                // æ­£å¸¸å‡ç´š
                const upgradeResult = creep.upgradeController(controller);
                
                if (upgradeResult == ERR_NOT_IN_RANGE) {
                    creep.moveTo(controller, {
                        visualizePathStyle: {stroke: '#00ff00'}  // ç¶ è‰²ï¼ˆå‡ç´šä¸­ï¼‰
                    });
                } else if (upgradeResult == OK) {
                    creep.say('âš¡');
                }
            }
        }
    }
    else {
        // --- æ¡é›†æ¨¡å¼: åœ¨æˆ¿é–“2æ¡é›† ---
        
        if (creep.room.name !== creep.memory.homeRoom) {
            // ä¸åœ¨å‡ºç”Ÿæˆ¿é–“ï¼Œè¿”å›
            const exitDir = creep.room.findExitTo(creep.memory.homeRoom);
            
            if (exitDir === ERR_NO_PATH || exitDir === ERR_INVALID_ARGS) {
                console.log(`[R2â†’R1] âŒ ${creep.name} æ‰¾ä¸åˆ°å› ${creep.memory.homeRoom} çš„è·¯å¾‘`);
                return;
            }
            
            const exit = creep.pos.findClosestByPath(exitDir);
            if (exit) {
                creep.moveTo(exit, {
                    visualizePathStyle: {stroke: '#ffaa00'}  // æ©˜è‰²ï¼ˆè¿”å›ä¸­ï¼‰
                });
            }
            return;
        }
        
        // === åœ¨æˆ¿é–“2æ’¿èƒ½é‡ï¼ˆå¾åœ°ä¸Šæˆ– Sourceï¼‰===
        
        // å„ªå…ˆæ’¿åœ°ä¸Šæ‰è½çš„èƒ½é‡
        const droppedEnergy = creep.pos.findClosestByPath(FIND_DROPPED_RESOURCES, {
            filter: r => r.resourceType === RESOURCE_ENERGY && r.amount > 50
        });
        
        if (droppedEnergy) {
            // åœ°ä¸Šæœ‰èƒ½é‡ï¼Œå»æ’¿
            if (creep.pickup(droppedEnergy) == ERR_NOT_IN_RANGE) {
                creep.moveTo(droppedEnergy, {
                    visualizePathStyle: {stroke: '#ffff00'}  // é»ƒè‰²ï¼ˆæ’¿èƒ½é‡ï¼‰
                });
            }
            creep.say('ğŸ’°');
        }
        else {
            // åœ°ä¸Šæ²’èƒ½é‡ï¼Œå‚™ç”¨æ–¹æ¡ˆï¼šå¾ Source æ¡é›†
            // ä½†åªåœ¨ Harvester ä¸åœ¨ä½æ™‚æ‰é€™æ¨£åš
            const source = creep.pos.findClosestByPath(FIND_SOURCES_ACTIVE);
            
            if (source) {
                const harvestResult = creep.harvest(source);
                
                if (harvestResult == ERR_NOT_IN_RANGE) {
                    creep.moveTo(source, {
                        visualizePathStyle: {stroke: '#ffff00'}  // é»ƒè‰²ï¼ˆæ¡é›†ï¼‰
                    });
                }
                creep.say('â›ï¸');
            }
        }
    }
}

// ============================================================
// ç¨‹å¼ç¢¼çµæŸ
// ============================================================
// æˆ¿é–“2é…ç½®ç¸½çµï¼ˆé›™é‡æ•‘æ´ç³»çµ± v3.0ï¼‰:
// âœ… 2 å€‹ Harvesterï¼ˆæ¡é›†èƒ½é‡ + è£œçµ¦å»ºç¯‰ï¼‰
// âœ… 1 å€‹æœ¬åœ° Upgraderï¼ˆå°ˆè·æ•‘æ´æˆ¿é–“2 Controllerï¼Œé˜²æ­¢ Downgradeï¼‰
// âœ… 2 å€‹è·¨æˆ¿é–“ Upgraderï¼ˆæ”¯æ´æˆ¿é–“1ï¼Œå¸¶é˜²æ“æ“ æ©Ÿåˆ¶ï¼‰
// âœ… è§£æ±º Controller å‡ç´šé™åˆ¶å•é¡Œï¼ˆ15 èƒ½é‡/tick ä¸Šé™ï¼‰
// âœ… ç°¡åŒ–å»ºç¯‰ç³»çµ±ï¼ˆä¸å»º Container/Tower/Storageï¼‰
// 
// ã€é‡è¦çŸ¥è­˜ã€‘Controller å‡ç´šé™åˆ¶ï¼š
// - æ¯å€‹ Controller æ¯ tick æœ€å¤šæ¥å— 15 èƒ½é‡çš„å‡ç´š
// - 1å€‹ WORK éƒ¨ä»¶ = 1 èƒ½é‡/tick
// - ç†è«–é£½å’Œï¼š15 å€‹ WORK éƒ¨ä»¶
// - å¯¦éš›å»ºè­°ï¼š2-3 å€‹ Upgraderï¼ˆæ¯å€‹ 3-4 WORKï¼‰= 9-12 èƒ½é‡/tick
// - è¶…éé€™å€‹æ•¸é‡æœƒå°è‡´æ“æ“ ï¼Œæ•ˆç‡åè€Œä¸‹é™ï¼
// 
// ç³»çµ±å·¥ä½œæµç¨‹:
// 1. Harvester æ¡é›† Source ä¸¦è£œçµ¦ Spawn/Extension
// 2. æœ¬åœ° Upgrader æŒçºŒå‡ç´šæˆ¿é–“2 Controllerï¼ˆé˜²æ­¢ Downgradeï¼‰
// 3. è·¨æˆ¿é–“ Upgrader åœ¨æˆ¿é–“2æ¡é›†èƒ½é‡
// 4. è·¨æˆ¿é–“ Upgrader å‰å¾€æˆ¿é–“1å‡ç´š Controller
// 5. åˆ°é”æˆ¿é–“1å¾Œæª¢æŸ¥å‘¨åœ Upgrader æ•¸é‡ï¼š
//    - å°‘æ–¼ 3 å€‹ï¼šæ­£å¸¸å‡ç´š
//    - è¶…é 3 å€‹ï¼šæš«æ™‚å”åŠ©å»ºé€ æˆ–ç­‰å¾…ï¼ˆé¿å…æ“æ“ ï¼‰
// 6. èƒ½é‡ç”¨å®Œå¾Œè¿”å›æˆ¿é–“2é‡è¤‡æµç¨‹
// 
// å„ªé»åˆ†æ:
// - â­ æ•‘æ´æˆ¿é–“2 Controller = é¿å… Downgrade å’Œé™ç´š
// - â­ é˜²æ“æ“ æ©Ÿåˆ¶ = å°Šé‡ Controller 15 èƒ½é‡/tick é™åˆ¶
// - â­ å‹•æ…‹åˆ†é… = äººå¤šæ™‚å”åŠ©å»ºé€ ï¼Œäººå°‘æ™‚å‡ç´š
// - â­ é›™æˆ¿é–“å¹³è¡¡ = å…©å€‹æˆ¿é–“éƒ½èƒ½ç©©å®šç™¼å±•
// 
// ä½¿ç”¨èªªæ˜:
// 1. ã€ç·Šæ€¥ã€‘ç«‹å³åŸ·è¡Œæ¸…é™¤å‘½ä»¤ï¼ˆè®“æ–°é…ç½®ç”Ÿæ•ˆï¼‰ï¼š
//    Game.rooms['W3N27'].find(FIND_MY_CREEPS).forEach(c => c.suicide());
// 
// 2. ç­‰å¾…æ–° creep ç”Ÿç”¢ï¼ˆå„ªå…ˆé †åºï¼‰ï¼š
//    - ç¬¬1å€‹ï¼šHarvesterï¼ˆæ¡é›†èƒ½é‡ï¼‰
//    - ç¬¬2å€‹ï¼šæœ¬åœ° Upgraderï¼ˆæ•‘æ´æˆ¿é–“2 Controllerï¼‰âš¡
//    - ç¬¬3å€‹ï¼šHarvesterï¼ˆå¢å¼·æ¡é›†ï¼‰
//    - ç¬¬4-5å€‹ï¼šè·¨æˆ¿é–“ Upgraderï¼ˆæ”¯æ´æˆ¿é–“1ï¼‰
// 
// 3. è§€å¯Ÿ Console è¼¸å‡ºï¼š
//    ğŸŒ [Room2] H:2 | LocalU:1 | CrossU:2
// 
// 4. è§€å¯Ÿæˆ¿é–“2 Controllerï¼š
//    - Downgrade å€’æ•¸è¨ˆæ™‚æ‡‰è©²åœæ­¢ä¸‹é™
//    - Progress æ‡‰è©²é–‹å§‹ä¸Šå‡
// 
// 5. è§€å¯Ÿæˆ¿é–“1 Controllerï¼š
//    - ä¸æ‡‰è©²å†æœ‰ creep å¡åœ¨å‘¨åœä¸å‹•
//    - æœ€å¤š 3 å€‹ creep åŒæ™‚å‡ç´š
//    - å¤šé¤˜çš„ creep æœƒå»å»ºé€ æˆ–ç­‰å¾…
// 
// è¦–è¦ºåŒ–æŒ‡ç¤º:
// - ğŸ“: Harvester æ­£åœ¨ç§»å‹•åˆ°å›ºå®šä½ç½®
// - â›ï¸: æ¡é›†ä¸­
// - ğŸ’°: æ’¿èƒ½é‡ä¸­
// - âš¡: å‡ç´šä¸­
// - ğŸ—ï¸: å»ºé€ ä¸­ï¼ˆé˜²æ“æ“ æ¨¡å¼ï¼‰
// - â¸ï¸: ç­‰å¾…ä¸­ï¼ˆé˜²æ“æ“ æ¨¡å¼ï¼‰
// - ğŸš€: å‡ºç™¼å‰å¾€æˆ¿é–“1
// - ğŸ”„: è¿”å›æˆ¿é–“2
// 
// è·¯å¾‘é¡è‰²:
// - é»ƒè‰²: æ¡é›†/æ’¿èƒ½é‡
// - ç¶ è‰²: å‡ç´šä¸­
// - é’è‰²: å‰å¾€æˆ¿é–“1
// - æ©˜è‰²: è¿”å›æˆ¿é–“2
// - ç™½è‰²: å»ºé€ ä¸­
// ============================================================
// 
// å„ªé»åˆ†æ:
// - â­ å›ºå®š Harvester ä¸ç§»å‹• = 100% å·¥ä½œæ•ˆç‡
// - â­ å…¶ä»– creep æ’¿èƒ½é‡ = ä¸æœƒåœ¨ Source æ“æ“ 
// - â­ æ”¯æ´ 4-5 å€‹ Upgrader = æ¯”ä¹‹å‰å¤š 2 å€ç”¢å‡º
// - â­ ç°¡å–®ç©©å®š = ä¸éœ€è¦è¤‡é›œçš„èª¿åº¦ç³»çµ±
// 
// ä½¿ç”¨èªªæ˜:
// 1. æ¸…é™¤æ‰€æœ‰èˆŠ creep: Game.rooms['W3N27'].find(FIND_MY_CREEPS).forEach(c => c.suicide());
// 2. ç­‰å¾…æ–° creep ç”Ÿç”¢ï¼ˆå…ˆç”Ÿç”¢ Harvesterï¼Œç„¶å¾Œç”Ÿç”¢ Upgraderï¼‰
// 3. è§€å¯Ÿ Harvester æ˜¯å¦ç«™åœ¨å›ºå®šä½ç½®æ¡é›†
// 4. è§€å¯Ÿåœ°ä¸Šæ˜¯å¦æœ‰æ‰è½çš„èƒ½é‡ï¼ˆé»ƒè‰²æ–¹å¡Šï¼‰
// 5. è§€å¯Ÿ Upgrader æ˜¯å¦æ’¿èƒ½é‡å¾Œå‰å¾€æˆ¿é–“1
// 
// è¦–è¦ºåŒ–æŒ‡ç¤º:
// - ğŸ“: Harvester æ­£åœ¨ç§»å‹•åˆ°å›ºå®šä½ç½®
// - â›ï¸: Harvester æ­£åœ¨æ¡é›†ï¼ˆæˆ– Upgrader å‚™ç”¨æ¡é›†ï¼‰
// - ğŸ’°: Upgrader æ­£åœ¨æ’¿åœ°ä¸Šçš„èƒ½é‡
// - ğŸš€: Upgrader èƒ½é‡æ»¿ï¼Œå‡ºç™¼å‰å¾€æˆ¿é–“1
// - ğŸ”„: Upgrader èƒ½é‡ç”¨å®Œï¼Œè¿”å›æˆ¿é–“2
// 
// è·¯å¾‘é¡è‰²:
// - æ©˜è‰²: Harvester ç§»å‹•/Upgrader è¿”å›ä¸­
// - é»ƒè‰²: æ’¿èƒ½é‡æˆ–æ¡é›†ä¸­
// - é’è‰²: å‰å¾€æˆ¿é–“1
// - ç¶ è‰²: åœ¨æˆ¿é–“1å‡ç´šä¸­
// ============================================================